<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scorito Klassiekers 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: {
            scorito: { 50:'#f0f9ff',100:'#e0f2fe',200:'#bae6fd',500:'#0ea5e9',600:'#0284c7',700:'#0369a1',800:'#075985',900:'#0c4a6e' }
        }}}}
    </script>
    <style>
        .loader{border:3px solid #e0f2fe;border-top:3px solid #0ea5e9;border-radius:50%;width:24px;height:24px;animation:spin .8s linear infinite;display:inline-block}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .tab-active{border-bottom:3px solid #0ea5e9;color:#0369a1;font-weight:600}
        table{border-collapse:collapse;width:100%}
        th{position:sticky;top:0;background:#f8fafc;z-index:10;cursor:pointer;user-select:none}
        th:hover{background:#e0f2fe}
        td,th{padding:6px 10px;text-align:left;border-bottom:1px solid #e2e8f0;font-size:13px}
        tr:hover td{background:#f0f9ff}
        .k1{background:linear-gradient(90deg,#fef3c7 0%,transparent 100%)}
        .k2{background:linear-gradient(90deg,#e5e7eb 0%,transparent 100%)}
        .k3{background:linear-gradient(90deg,#fed7aa 0%,transparent 100%)}
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
<header class="bg-white border-b shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-scorito-800">Scorito Klassiekers 2026</h1>
                <p class="text-sm text-gray-500">Team optimizer & kopmanstrategie</p>
            </div>
            <div id="stats" class="text-sm text-gray-500"><div class="loader"></div> Laden...</div>
        </div>
        <nav class="flex gap-6 mt-4 -mb-px text-sm">
            <button onclick="showTab('riders')" id="tab-riders" class="pb-2 px-1 tab-active">Rennersoverzicht</button>
            <button onclick="showTab('team')" id="tab-team" class="pb-2 px-1 text-gray-500 hover:text-gray-700">Optimaal Team</button>
            <button onclick="showTab('kopman')" id="tab-kopman" class="pb-2 px-1 text-gray-500 hover:text-gray-700">Kopmanstrategie</button>
            <button onclick="showTab('builder')" id="tab-builder" class="pb-2 px-1 text-gray-500 hover:text-gray-700">Team Builder</button>
            <button onclick="showTab('news')" id="tab-news" class="pb-2 px-1 text-gray-500 hover:text-gray-700">Nieuws & Blessures <span id="newsCount" class="hidden bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 ml-1">0</span></button>
        </nav>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-6">
    <!-- RIDERS -->
    <div id="page-riders">
        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                <div><label class="block text-xs font-medium text-gray-600 mb-1">Zoeken</label><input type="text" id="search" placeholder="Naam of team..." class="w-full border rounded-lg px-3 py-1.5 text-sm" oninput="renderRiders()"></div>
                <div><label class="block text-xs font-medium text-gray-600 mb-1">Type</label><select id="typeFilter" class="w-full border rounded-lg px-3 py-1.5 text-sm" onchange="renderRiders()"><option value="">Alle</option><option value="Cobbles">Cobbles</option><option value="Hills">Hills</option><option value="Sprinter">Sprinter</option><option value="Other">Other</option></select></div>
                <div><label class="block text-xs font-medium text-gray-600 mb-1">Min. koersen</label><input type="number" id="minRaces" value="1" min="0" max="17" class="w-full border rounded-lg px-3 py-1.5 text-sm" oninput="renderRiders()"></div>
                <div><label class="block text-xs font-medium text-gray-600 mb-1">Min. prijs (M)</label><input type="number" id="minPrice" value="0" min="0" max="7" step="0.25" class="w-full border rounded-lg px-3 py-1.5 text-sm" oninput="renderRiders()"></div>
                <div><label class="block text-xs font-medium text-gray-600 mb-1">Sorteer</label><select id="sortSelect" class="w-full border rounded-lg px-3 py-1.5 text-sm" onchange="sortField=this.value;sortAsc=false;renderRiders()"><option value="expTotal">Verwachte punten</option><option value="value">Waarde (pts/M)</option><option value="priceM">Prijs</option><option value="numRaces">Koersen</option></select></div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow overflow-hidden"><div class="overflow-auto" style="max-height:72vh">
            <table><thead><tr class="text-xs text-gray-500 uppercase">
                <th onclick="toggleSort('name')">Naam</th><th onclick="toggleSort('team')">Team</th><th onclick="toggleSort('priceM')">Prijs</th><th onclick="toggleSort('type')">Type</th><th onclick="toggleSort('numRaces')">Koersen</th>
                <th onclick="toggleSort('q.sprint')" class="text-center">Spr</th><th onclick="toggleSort('q.punch')" class="text-center">Pun</th><th onclick="toggleSort('q.hill')" class="text-center">Hil</th><th onclick="toggleSort('q.cobbles')" class="text-center">Cob</th>
                <th onclick="toggleSort('expTotal')">Exp.</th><th onclick="toggleSort('adjExpTotal')">Adj.</th><th onclick="toggleSort('adjValue')">Waarde</th><th class="text-center">+/-</th>
            </tr></thead><tbody id="ridersBody"></tbody></table>
        </div></div>
    </div>

    <!-- OPTIMAL TEAM -->
    <div id="page-team" class="hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-4">
            <button onclick="runOptimizer()" class="bg-scorito-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-scorito-700 transition">Optimaliseer Team</button>
            <span id="optLoader" class="hidden ml-3"><div class="loader"></div></span>
        </div>
        <div id="teamResult" class="hidden">
            <div class="grid grid-cols-4 gap-4 mb-4" id="teamMetrics"></div>
            <div class="bg-white rounded-lg shadow overflow-hidden"><table>
                <thead><tr class="text-xs text-gray-500 uppercase"><th>#</th><th>Naam</th><th>Team</th><th>Prijs</th><th>Type</th><th>Koersen</th><th class="text-center">Spr</th><th class="text-center">Pun</th><th class="text-center">Hil</th><th class="text-center">Cob</th><th>Exp.</th><th>Waarde</th></tr></thead>
                <tbody id="teamBody"></tbody>
            </table></div>
        </div>
    </div>

    <!-- KOPMAN -->
    <div id="page-kopman" class="hidden"><div id="kopmanContent"><p class="text-gray-500 bg-white rounded-lg shadow p-6">Genereer eerst een team op "Optimaal Team".</p></div></div>

    <!-- BUILDER -->
    <div id="page-builder" class="hidden">
        <div class="grid grid-cols-4 gap-4 mb-4">
            <div class="bg-white rounded-lg shadow p-4"><div class="text-xs text-gray-500">Renners</div><div id="bCount" class="text-xl font-bold">0/20</div></div>
            <div class="bg-white rounded-lg shadow p-4"><div class="text-xs text-gray-500">Budget</div><div id="bBudget" class="text-xl font-bold">-</div></div>
            <div class="bg-white rounded-lg shadow p-4"><div class="text-xs text-gray-500">Resterend</div><div id="bLeft" class="text-xl font-bold">-</div></div>
            <div class="bg-white rounded-lg shadow p-4"><div class="text-xs text-gray-500">Exp. punten</div><div id="bPts" class="text-xl font-bold">0</div></div>
        </div>
        <div class="flex gap-2 mb-4">
            <button onclick="loadOptimalToBuilder()" class="bg-scorito-100 text-scorito-700 px-4 py-1.5 rounded-lg text-sm font-medium hover:bg-scorito-200">Laad optimaal team</button>
            <button onclick="builderIds.clear();renderBuilder();renderRiders()" class="bg-gray-100 text-gray-600 px-4 py-1.5 rounded-lg text-sm hover:bg-gray-200">Wis team</button>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="p-3 border-b font-medium text-sm">Jouw team</div>
                <div class="overflow-auto" style="max-height:58vh"><table><thead><tr class="text-xs text-gray-500 uppercase"><th>Naam</th><th>Team</th><th>Prijs</th><th>Koersen</th><th>Exp.</th><th></th></tr></thead><tbody id="bTeamBody"></tbody></table></div>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="p-3 border-b font-medium text-sm flex justify-between"><span>Beschikbaar</span><input type="text" id="bSearch" placeholder="Zoek..." class="border rounded px-2 py-1 text-xs" oninput="renderBuilderAvail()"></div>
                <div class="overflow-auto" style="max-height:58vh"><table><thead><tr class="text-xs text-gray-500 uppercase"><th>Naam</th><th>Prijs</th><th>Type</th><th>Koersen</th><th>Exp.</th><th></th></tr></thead><tbody id="bAvailBody"></tbody></table></div>
            </div>
        </div>
    </div>

    <!-- NEWS & INJURIES -->
    <div id="page-news" class="hidden">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold">Nieuws & Blessures</h2>
            <div class="flex items-center gap-3">
                <span id="newsUpdated" class="text-xs text-gray-400"></span>
                <button onclick="fetchNews()" id="newsRefreshBtn" class="bg-scorito-600 text-white px-4 py-1.5 rounded-lg text-sm font-medium hover:bg-scorito-700 transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    Ververs
                </button>
            </div>
        </div>

        <!-- Rider alerts -->
        <div id="riderAlerts" class="mb-6"></div>

        <!-- Feed status -->
        <div id="feedStatus" class="mb-4"></div>

        <!-- Articles -->
        <div id="newsArticles" class="space-y-3">
            <p class="text-gray-500 bg-white rounded-lg shadow p-6">Klik op "Ververs" om het laatste nieuws op te halen.</p>
        </div>
    </div>
</main>

<script>
// ── State ──
let D = null; // all data
let sortField = 'adjExpTotal', sortAsc = false;
let optTeam = null, optStrategy = null;
let builderIds = new Set();
let newsData = null; // { articles, riderAlerts, feedStatus }
const BUDGET = 50000000;

// ── Init ──
async function init() {
    const r = await fetch('/data.json');
    D = await r.json();
    // Initialize adjusted values = base values
    for (const r of D.riders) {
        r.adjExp = { ...r.exp };
        r.adjExpTotal = r.expTotal;
        r.adjValue = r.value;
        r.missedRaces = [];
        r.severity = null;
    }
    document.getElementById('stats').textContent = `${D.totalRiders} renners | ${Object.keys(D.raceNames).length} koersen | Budget €${BUDGET/1e6}M`;
    renderRiders();
    // Auto-fetch news on load
    fetchNews();
}

// ── Adjust points based on injuries ──
function applyInjuryAdjustments() {
    if (!newsData || !D) return;
    for (const r of D.riders) {
        // Reset to base
        r.adjExp = { ...r.exp };
        r.adjExpTotal = r.expTotal;
        r.adjValue = r.value;
        r.missedRaces = [];
        r.severity = null;

        const alert = newsData.riderAlerts[r.id];
        if (alert && alert.status === 'warning' && alert.missedRaces?.length > 0) {
            r.severity = alert.severity;
            r.missedRaces = alert.missedRaces;
            // Zero out points for missed races
            let adjTotal = 0;
            for (const [race, pts] of Object.entries(r.exp)) {
                if (alert.missedRaces.includes(race)) {
                    r.adjExp[race] = 0;
                } else {
                    r.adjExp[race] = pts;
                }
                adjTotal += r.adjExp[race];
            }
            r.adjExpTotal = adjTotal;
            r.adjValue = r.priceM > 0 ? adjTotal / r.priceM : 0;
        }
    }
}

// ── Tabs ──
function showTab(n) {
    ['riders','team','kopman','builder','news'].forEach(t => {
        document.getElementById('page-'+t).classList.toggle('hidden', t!==n);
        const tb = document.getElementById('tab-'+t);
        tb.classList.toggle('tab-active', t===n);
        tb.classList.toggle('text-gray-500', t!==n);
    });
    if (n==='builder') renderBuilder();
    if (n==='news' && !newsData) fetchNews();
}

// ── Helpers ──
function qb(v) {
    if (!v) return '<span class="text-gray-300">-</span>';
    const c = {2:'bg-gray-200 text-gray-600',4:'bg-blue-100 text-blue-700',6:'bg-green-100 text-green-700',8:'bg-orange-100 text-orange-700',10:'bg-red-100 text-red-700'}[v]||'bg-gray-100';
    return `<span class="inline-block px-1.5 py-0.5 rounded text-xs font-medium ${c}">${v}</span>`;
}
function tc(t) {
    return {Cobbles:'bg-amber-100 text-amber-800',Hills:'bg-green-100 text-green-800',Sprinter:'bg-purple-100 text-purple-800',Other:'bg-gray-100 text-gray-600'}[t]||'bg-gray-100 text-gray-600';
}
function getVal(obj, path) { return path.split('.').reduce((o,k)=>o?.[k], obj) ?? 0; }

// ── Sort ──
function toggleSort(f) { if(sortField===f) sortAsc=!sortAsc; else { sortField=f; sortAsc=false; } renderRiders(); }

// ── Riders ──
function renderRiders() {
    if (!D) return;
    const s = (document.getElementById('search')?.value||'').toLowerCase();
    const tp = document.getElementById('typeFilter')?.value||'';
    const mr = parseInt(document.getElementById('minRaces')?.value)||0;
    const mp = parseFloat(document.getElementById('minPrice')?.value)||0;

    let list = D.riders.filter(r =>
        (r.name.toLowerCase().includes(s) || r.team.toLowerCase().includes(s)) &&
        (!tp || r.type===tp) && r.numRaces>=mr && r.priceM>=mp
    );
    list.sort((a,b) => {
        let va=getVal(a,sortField), vb=getVal(b,sortField);
        if (typeof va==='string') return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
        return sortAsc ? va-vb : vb-va;
    });

    document.getElementById('ridersBody').innerHTML = list.slice(0,300).map(r => `<tr>
        <td class="font-medium">${r.name}${injuryBadge(r.id)}</td>
        <td class="text-gray-500 text-xs max-w-[140px] truncate">${r.team}</td>
        <td class="font-mono text-xs">€${r.priceM.toFixed(2)}M</td>
        <td><span class="inline-block px-1.5 py-0.5 rounded-full text-xs font-medium ${tc(r.type)}">${r.type}</span></td>
        <td class="text-center">${r.numRaces}</td>
        <td class="text-center">${qb(r.q.sprint)}</td>
        <td class="text-center">${qb(r.q.punch)}</td>
        <td class="text-center">${qb(r.q.hill)}</td>
        <td class="text-center">${qb(r.q.cobbles)}</td>
        <td class="font-mono text-xs text-gray-400">${r.expTotal.toFixed(1)}</td>
        <td class="font-mono font-medium ${r.adjExpTotal < r.expTotal ? 'text-red-600' : ''}">${r.adjExpTotal.toFixed(1)}${r.missedRaces.length ? ' <span class="text-red-400 text-xs">-'+r.missedRaces.length+'</span>' : ''}</td>
        <td class="font-mono text-xs">${r.adjValue.toFixed(1)}</td>
        <td class="text-center"><button onclick="toggleB(${r.id})" class="text-xs px-2 py-0.5 rounded ${builderIds.has(r.id)?'bg-red-100 text-red-700':'bg-scorito-100 text-scorito-700'}">${builderIds.has(r.id)?'−':'+'}</button></td>
    </tr>`).join('');
}

// ── Optimizer (client-side greedy, uses adjusted points) ──
function runOptimizer() {
    document.getElementById('optLoader').classList.remove('hidden');
    setTimeout(() => {
        // Use adjusted points (injury-aware)
        const candidates = D.riders.filter(r => r.numRaces > 0 && r.adjExpTotal > 0)
            .sort((a,b) => b.adjValue - a.adjValue);
        let team = [], budget = BUDGET, picked = new Set();

        // First: force top adjusted-points riders
        const byExp = [...candidates].sort((a,b) => b.adjExpTotal - a.adjExpTotal);
        for (const r of byExp.slice(0, 8)) {
            if (budget >= r.price && team.length < 20) {
                team.push(r); budget -= r.price; picked.add(r.id);
            }
        }

        // Fill remaining by adjusted value score
        for (const r of candidates) {
            if (team.length >= 20) break;
            if (picked.has(r.id)) continue;
            if (budget >= r.price) {
                team.push(r); budget -= r.price; picked.add(r.id);
            }
        }

        team.sort((a,b) => b.adjExpTotal - a.adjExpTotal);
        optTeam = team;

        // Kopman strategy using adjusted per-race points
        optStrategy = {};
        for (const [race, displayName] of Object.entries(D.raceNames)) {
            const racing = team.filter(r => r.races[race] && (r.adjExp[race]||0) > 0)
                .sort((a,b) => (b.adjExp[race]||0) - (a.adjExp[race]||0));
            const mults = [3.0, 2.5, 2.0];
            optStrategy[race] = {
                displayName,
                riders: racing.map((r, i) => ({
                    rank: i+1, name: r.name, id: r.id,
                    mult: i < 3 ? mults[i] : 1.0,
                    base: r.adjExp[race]||0,
                    origBase: r.exp[race]||0,
                    boosted: (r.adjExp[race]||0) * (i < 3 ? mults[i] : 1.0),
                    missed: r.missedRaces.includes(race),
                }))
            };
        }

        renderTeam();
        renderKopman();
        document.getElementById('optLoader').classList.add('hidden');
    }, 50);
}

function renderTeam() {
    if (!optTeam) return;
    const cost = optTeam.reduce((s,r) => s+r.price, 0);
    const expAdj = optTeam.reduce((s,r) => s+r.adjExpTotal, 0);
    let expKop = 0;
    for (const d of Object.values(optStrategy)) {
        for (const r of d.riders) expKop += r.boosted;
    }
    const avgR = (optTeam.reduce((s,r) => s+r.numRaces, 0) / optTeam.length).toFixed(1);
    const injured = optTeam.filter(r => r.missedRaces.length > 0).length;

    document.getElementById('teamResult').classList.remove('hidden');
    document.getElementById('teamMetrics').innerHTML = `
        <div class="bg-scorito-50 rounded-lg p-4"><div class="text-xs text-gray-500">Budget</div><div class="text-xl font-bold text-scorito-800">€${(cost/1e6).toFixed(1)}M / €50M</div><div class="text-xs text-gray-500">€${((BUDGET-cost)/1e6).toFixed(1)}M over</div></div>
        <div class="bg-blue-50 rounded-lg p-4"><div class="text-xs text-gray-500">Adj. punten (basis)</div><div class="text-xl font-bold text-blue-800">${Math.round(expAdj)}</div>${injured?'<div class="text-xs text-red-500">'+injured+' geblesseerd</div>':''}</div>
        <div class="bg-green-50 rounded-lg p-4"><div class="text-xs text-gray-500">Adj. punten (met kopman)</div><div class="text-xl font-bold text-green-700">${Math.round(expKop)}</div><div class="text-xs text-green-600">+${Math.round(expKop-expAdj)} bonus</div></div>
        <div class="bg-orange-50 rounded-lg p-4"><div class="text-xs text-gray-500">Gem. koersen/renner</div><div class="text-xl font-bold text-orange-700">${avgR}</div></div>`;

    document.getElementById('teamBody').innerHTML = optTeam.map((r,i) => `<tr class="${r.missedRaces.length ? 'bg-red-50' : ''}">
        <td class="text-gray-400">${i+1}</td>
        <td class="font-medium">${r.name}${injuryBadge(r.id)}${r.missedRaces.length ? ' <span class="text-xs text-red-500">mist '+r.missedRaces.length+'</span>' : ''}</td>
        <td class="text-gray-500 text-xs">${r.team}</td>
        <td class="font-mono text-xs">€${r.priceM.toFixed(2)}M</td><td><span class="inline-block px-1.5 py-0.5 rounded-full text-xs font-medium ${tc(r.type)}">${r.type}</span></td>
        <td class="text-center">${r.numRaces}</td>
        <td class="text-center">${qb(r.q.sprint)}</td><td class="text-center">${qb(r.q.punch)}</td><td class="text-center">${qb(r.q.hill)}</td><td class="text-center">${qb(r.q.cobbles)}</td>
        <td class="font-mono font-medium ${r.adjExpTotal < r.expTotal ? 'text-red-600' : ''}">${r.adjExpTotal.toFixed(1)}</td>
        <td class="font-mono text-xs">${r.adjValue.toFixed(1)}</td>
    </tr>`).join('');
}

// ── Kopman ──
function renderKopman() {
    if (!optStrategy) return;
    const races = Object.entries(optStrategy).filter(([_,d]) => d.riders.length > 0);
    let gt = 0;

    let html = `<p class="text-sm text-gray-600 mb-4">Per koers: <b>1e kopman (3x)</b>, <b>2e kopman (2.5x)</b>, <b>3e kopman (2x)</b></p>
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6"><table>
    <thead><tr class="text-xs text-gray-500 uppercase"><th>Koers</th><th>1e Kopman (3x)</th><th>2e Kopman (2.5x)</th><th>3e Kopman (2x)</th><th>Totaal</th></tr></thead><tbody>`;

    for (const [race, data] of races) {
        const tot = data.riders.reduce((s,r) => s+r.boosted, 0);
        gt += tot;
        const k = i => data.riders[i] ? `<b>${data.riders[i].name}</b> <span class="text-gray-400 text-xs">${data.riders[i].base}×${data.riders[i].mult}=${data.riders[i].boosted.toFixed(1)}</span>` : '-';
        html += `<tr><td class="font-medium text-sm">${data.displayName}</td><td class="k1 text-sm">${k(0)}</td><td class="k2 text-sm">${k(1)}</td><td class="k3 text-sm">${k(2)}</td><td class="font-mono font-medium">${tot.toFixed(1)}</td></tr>`;
    }
    html += `</tbody><tfoot><tr class="font-bold bg-scorito-50"><td colspan="4">Totaal verwachte punten</td><td class="font-mono">${gt.toFixed(0)}</td></tr></tfoot></table></div>`;

    // Detail cards
    html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
    for (const [race, data] of races) {
        const q = D.raceQualities[race] || {};
        html += `<div class="bg-white rounded-lg shadow p-4"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-sm">${data.displayName}</h3><span class="text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-600">${(q.primary||'').charAt(0).toUpperCase()+(q.primary||'').slice(1)}${q.secondary ? ' / '+(q.secondary||'').charAt(0).toUpperCase()+(q.secondary||'').slice(1) : ''}</span></div>`;
        const medals = ['\u{1F947}','\u{1F948}','\u{1F949}'];
        for (const r of data.riders.slice(0,6)) {
            const isK = r.rank <= 3;
            html += `<div class="flex justify-between text-sm py-0.5 ${isK?'font-medium':'text-gray-500'}"><span>${isK?medals[r.rank-1]:''} ${r.name}</span><span class="font-mono text-xs">${r.base.toFixed(1)}${isK?' × '+r.mult+'x = <b>'+r.boosted.toFixed(1)+'</b>':''}</span></div>`;
        }
        html += '</div>';
    }
    html += '</div>';
    document.getElementById('kopmanContent').innerHTML = html;
}

// ── Builder ──
function toggleB(id) {
    if (builderIds.has(id)) builderIds.delete(id);
    else if (builderIds.size < 20) builderIds.add(id);
    renderRiders(); renderBuilder();
}

function renderBuilder() {
    if (!D) return;
    const team = D.riders.filter(r => builderIds.has(r.id)).sort((a,b) => b.expTotal - a.expTotal);
    const cost = team.reduce((s,r) => s+r.price, 0);
    const left = BUDGET - cost;
    const pts = team.reduce((s,r) => s+r.adjExpTotal, 0);

    document.getElementById('bCount').textContent = `${team.length}/20`;
    document.getElementById('bBudget').textContent = `€${(cost/1e6).toFixed(2)}M`;
    document.getElementById('bLeft').textContent = `€${(left/1e6).toFixed(2)}M`;
    document.getElementById('bLeft').className = `text-xl font-bold ${left<0?'text-red-600':'text-green-600'}`;
    document.getElementById('bPts').textContent = pts.toFixed(0);

    document.getElementById('bTeamBody').innerHTML = team.map(r => `<tr class="${r.missedRaces.length ? 'bg-red-50' : ''}">
        <td class="font-medium text-sm">${r.name}${injuryBadge(r.id)}${r.missedRaces.length ? ' <span class="text-xs text-red-500">-'+r.missedRaces.length+'</span>' : ''}</td><td class="text-gray-500 text-xs">${r.team}</td>
        <td class="font-mono text-xs">€${r.priceM.toFixed(2)}M</td><td class="text-center">${r.numRaces}</td><td class="font-mono text-sm ${r.adjExpTotal < r.expTotal ? 'text-red-600' : ''}">${r.adjExpTotal.toFixed(1)}</td>
        <td><button onclick="toggleB(${r.id})" class="text-xs px-2 py-0.5 rounded bg-red-100 text-red-700">&minus;</button></td>
    </tr>`).join('') || '<tr><td colspan="6" class="text-gray-400 text-center py-8">Voeg renners toe via + knopje</td></tr>';

    renderBuilderAvail();
}

function renderBuilderAvail() {
    const s = (document.getElementById('bSearch')?.value||'').toLowerCase();
    const avail = D.riders.filter(r => !builderIds.has(r.id) && r.numRaces>0 && (r.name.toLowerCase().includes(s)||r.team.toLowerCase().includes(s)))
        .sort((a,b) => b.adjValue - a.adjValue).slice(0, 100);
    document.getElementById('bAvailBody').innerHTML = avail.map(r => `<tr>
        <td class="text-sm">${r.name}</td><td class="font-mono text-xs">€${r.priceM.toFixed(2)}M</td>
        <td><span class="inline-block px-1 py-0.5 rounded text-xs ${tc(r.type)}">${r.type}</span></td>
        <td class="text-center">${r.numRaces}</td><td class="font-mono text-sm ${r.adjExpTotal < r.expTotal ? 'text-red-600' : ''}">${r.adjExpTotal.toFixed(1)}</td>
        <td><button onclick="toggleB(${r.id})" class="text-xs px-2 py-0.5 rounded bg-scorito-100 text-scorito-700" ${builderIds.size>=20?'disabled':''}>&plus;</button></td>
    </tr>`).join('');
}

function loadOptimalToBuilder() {
    if (!optTeam) { alert('Genereer eerst een optimaal team'); return; }
    builderIds = new Set(optTeam.map(r => r.id));
    renderBuilder(); renderRiders();
}

// ── News & Injuries ──
async function fetchNews() {
    const btn = document.getElementById('newsRefreshBtn');
    btn.disabled = true;
    btn.innerHTML = '<div class="loader" style="width:16px;height:16px;border-width:2px"></div> Laden...';

    try {
        const resp = await fetch('/api/news');
        newsData = await resp.json();
        applyInjuryAdjustments();
        renderNews();
        renderRiders(); // re-render with adjusted points
    } catch (e) {
        document.getElementById('newsArticles').innerHTML = `<div class="bg-red-50 text-red-700 rounded-lg p-4">Fout bij laden: ${e.message}</div>`;
    }

    btn.disabled = false;
    btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Ververs';
}

function renderNews() {
    if (!newsData) return;

    // Update badge
    const warnings = Object.values(newsData.riderAlerts).filter(a => a.status === 'warning');
    const badge = document.getElementById('newsCount');
    if (warnings.length > 0) {
        badge.textContent = warnings.length;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }

    // Last updated
    if (newsData.lastUpdated) {
        const d = new Date(newsData.lastUpdated);
        document.getElementById('newsUpdated').textContent = `Laatst bijgewerkt: ${d.toLocaleTimeString('nl-NL')}`;
    }

    // Feed status
    const fs = newsData.feedStatus || [];
    document.getElementById('feedStatus').innerHTML = `<div class="flex gap-2 flex-wrap">${fs.map(f =>
        `<span class="text-xs px-2 py-1 rounded ${f.status==='ok'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${f.name}: ${f.count} artikelen</span>`
    ).join('')}</div>`;

    // Severity labels
    const sevLabel = { long: 'Lang (seizoen)', medium: 'Medium (~4 wk)', short: 'Kort (~1-2 wk)', dns: 'DNS', unknown: 'Onbekend' };
    const sevColor = { long: 'bg-red-600', medium: 'bg-orange-500', short: 'bg-yellow-500', dns: 'bg-gray-500', unknown: 'bg-gray-400' };

    // Rider alerts (injuries/warnings)
    const alertsHtml = warnings.length > 0 ? `
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <h3 class="font-bold text-red-800 mb-2">Blessure / DNS waarschuwingen (${warnings.length})</h3>
            <div class="space-y-2">
                ${warnings.sort((a,b) => (b.missedRaces?.length||0) - (a.missedRaces?.length||0)).map(a => {
                    const rider = D?.riders.find(r => r.id === a.id);
                    const ptsLost = rider ? (rider.expTotal - rider.adjExpTotal).toFixed(1) : '?';
                    return `
                    <div class="flex items-start gap-3 bg-white rounded p-3 border border-red-100">
                        <span class="text-red-500 text-lg mt-0.5">&#x26A0;</span>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="font-medium">${a.name}</span>
                                <span class="text-xs text-gray-500">${a.team}</span>
                                <span class="text-xs text-white px-1.5 py-0.5 rounded ${sevColor[a.severity]||sevColor.unknown}">${sevLabel[a.severity]||'?'}</span>
                                ${a.returnDate ? `<span class="text-xs text-gray-400">Terug: ~${a.returnDate}</span>` : ''}
                            </div>
                            ${a.missedRaces?.length ? `<div class="mt-1 flex gap-1 flex-wrap">
                                <span class="text-xs text-red-600 font-medium">Mist ${a.missedRaces.length} koersen:</span>
                                ${a.missedRaces.map(r => `<span class="text-xs px-1.5 py-0.5 rounded bg-red-100 text-red-700 line-through">${D?.raceNames?.[r] || r}</span>`).join('')}
                            </div>` : ''}
                            <div class="mt-1 text-xs text-red-600 font-medium">-${ptsLost} verwachte punten</div>
                            <div class="text-sm text-gray-600 mt-1">
                                ${a.articles.filter(ar => ar.isInjury).slice(0, 2).map(ar =>
                                    `<a href="${ar.link}" target="_blank" class="block text-scorito-600 hover:underline text-xs">${ar.title} <span class="text-gray-400">(${ar.source || 'News'})</span></a>`
                                ).join('')}
                            </div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </div>
    ` : '<div class="bg-green-50 border border-green-200 rounded-lg p-3 text-green-700 text-sm">Geen blessurewaarschuwingen gevonden.</div>';
    document.getElementById('riderAlerts').innerHTML = alertsHtml;

    // All articles
    const articles = newsData.articles || [];
    document.getElementById('newsArticles').innerHTML = articles.length > 0 ?
        articles.map(a => `
            <a href="${a.link}" target="_blank" class="block bg-white rounded-lg shadow p-4 hover:shadow-md transition">
                <div class="flex justify-between items-start gap-4">
                    <div>
                        <div class="font-medium text-sm">${a.title}</div>
                        <div class="text-xs text-gray-500 mt-1">${a.description?.slice(0, 150) || ''}${a.description?.length > 150 ? '...' : ''}</div>
                        ${a.matchedRiders?.length ? `<div class="mt-2 flex gap-1 flex-wrap">${a.matchedRiders.map(n => `<span class="text-xs px-1.5 py-0.5 rounded bg-scorito-100 text-scorito-700">${n}</span>`).join('')}</div>` : ''}
                    </div>
                    <div class="text-right shrink-0">
                        <div class="text-xs text-gray-400">${a.feedSource || ''}</div>
                        <div class="text-xs text-gray-400">${a.date ? new Date(a.date).toLocaleDateString('nl-NL', {day:'numeric',month:'short'}) : ''}</div>
                    </div>
                </div>
            </a>
        `).join('') :
        '<p class="text-gray-500 bg-white rounded-lg shadow p-6">Geen artikelen gevonden.</p>';
}

// Injury badge helper for rider tables
function injuryBadge(riderId) {
    if (!newsData?.riderAlerts?.[riderId]) return '';
    const a = newsData.riderAlerts[riderId];
    if (a.status === 'warning') return ' <span class="text-red-500 text-xs" title="Mogelijke blessure/DNS">&#x26A0;</span>';
    return ' <span class="text-scorito-500 text-xs" title="In het nieuws">&#x1F4F0;</span>';
}

init();
</script>
</body>
</html>
